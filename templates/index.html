<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medical Lab Report Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <style>
    /* Custom scrollbar for chat container */
    #chatContainer::-webkit-scrollbar {
      width: 8px;
    }
    #chatContainer::-webkit-scrollbar-thumb {
      background-color: #4caf50;
      border-radius: 4px;
    }
    #chatContainer::-webkit-scrollbar-track {
      background: #f0f0f0;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-700 to-purple-900 min-h-screen p-5 font-sans">
  <div
    id="popup-overlay"
    role="dialog"
    aria-modal="true"
    aria-labelledby="popup-header-title"
    aria-hidden="false"
    class="fixed inset-0 bg-black bg-opacity-50 flex z-50 justify-center items-center p-4"
  >
    <div
      id="popup-container"
      class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col overflow-hidden"
    >
      <button
        id="popup-close-btn"
        aria-label="Close popup"
        class="absolute top-4 right-4 text-green-600 hover:text-green-800 text-3xl font-bold leading-none focus:outline-none"
        onclick="closePopup()"
      >
        &times;
      </button>

      <header
        id="popup-header"
        class="bg-gradient-to-r from-green-600 to-green-700 text-white text-center p-8 flex flex-col items-center"
      >
        <h1
          id="popup-header-title"
          class="text-4xl sm:text-5xl font-light mb-2 select-none"
        >
          üè• Medical Lab Report Analyzer
        </h1>
        <p class="text-lg opacity-90 max-w-xl">
          Upload your lab report and get simple explanations of your results
        </p>
      </header>

      <main
        id="popup-main-content"
        class="p-10 overflow-y-auto flex-grow space-y-8"
      >
        <section class="upload-section text-center space-y-6">
          <div
            id="uploadArea"
            class="border-4 border-dashed border-gray-300 rounded-xl bg-gray-50 p-16 cursor-pointer relative transition-transform duration-300 hover:border-green-600 hover:bg-green-50 flex flex-col items-center justify-center select-none"
            tabindex="0"
            aria-label="Drop your PDF here or click to browse"
          >
            <div class="text-7xl text-gray-300 mb-6 select-none">üìÑ</div>
            <div class="text-lg text-gray-600 mb-6 font-semibold">
              Drop your PDF here or click to browse
              <br />
              <small class="text-sm text-gray-400 font-normal">
                Maximum file size: 16MB
              </small>
            </div>
            <input
              type="file"
              id="pdfFile"
              class="hidden"
              accept=".pdf"
              aria-hidden="true"
            />
            <button
              type="button"
              onclick="document.getElementById('pdfFile').click()"
              class="inline-block bg-gradient-to-r from-green-600 to-green-700 text-white py-3 px-8 rounded-full font-semibold shadow-md hover:from-green-700 hover:to-green-800 focus:outline-none focus:ring-4 focus:ring-green-400 transition"
            >
              Choose PDF File
            </button>
          </div>

          <div
            id="uploadLoading"
            class="text-gray-600 italic hidden select-none"
            aria-live="polite"
          >
            Uploading and processing your PDF
          </div>
        </section>

        <section
          id="chatSection"
          class="hidden flex flex-col space-y-6"
          aria-live="polite"
        >
          <div
            id="fileInfo"
            class="bg-green-50 border-l-4 border-green-600 p-4 rounded-md text-green-800 text-sm sm:text-base"
          ></div>

          <div
            id="chatContainer"
            class="border border-gray-300 rounded-xl bg-gray-50 p-6 h-96 overflow-y-auto space-y-4"
            tabindex="0"
            aria-label="Chat messages"
          >
            <div
              class="message bot-message bg-white border border-gray-300 text-gray-800 rounded-xl p-4 max-w-[80%] break-words"
            >
              <strong>ü§ñ Medical Assistant:</strong><br />
              Hello! I've successfully processed your lab report. I can help
              explain:
              <ul class="list-disc list-inside mt-2 space-y-1">
                <li>What each test measures</li>
                <li>Normal ranges for lab values</li>
                <li>What high or low results might indicate</li>
                <li>Medical terms in simple language</li>
              </ul>
              <em class="block mt-3 text-sm text-gray-600"
                >Please remember: I provide educational information only. Always
                consult your healthcare provider for medical advice.</em
              >
            </div>
          </div>

          <div class="flex gap-4">
            <input
              type="text"
              id="questionInput"
              class="flex-grow border border-gray-300 rounded-full px-5 py-3 text-gray-900 text-base focus:outline-none focus:ring-2 focus:ring-green-600 focus:border-green-600"
              placeholder="Ask about your lab results..."
              onkeypress="handleKeyPress(event)"
              aria-label="Ask about your lab results"
              autocomplete="off"
            />
            <button
              id="askBtn"
              type="button"
              onclick="askQuestion()"
              class="bg-gradient-to-r from-green-600 to-green-700 text-white font-semibold rounded-full px-6 py-3 shadow-md hover:from-green-700 hover:to-green-800 focus:outline-none focus:ring-4 focus:ring-green-400 transition disabled:bg-gray-300 disabled:cursor-not-allowed"
            >
              Ask
            </button>
          </div>

          <div>
            <h3 class="text-green-700 font-semibold mb-3 text-lg select-none">
              Sample Questions:
            </h3>
            <div class="flex flex-wrap gap-3">
              <div
                tabindex="0"
                role="button"
                class="sample-question cursor-pointer bg-gray-200 hover:bg-gray-300 rounded-full px-4 py-2 text-sm select-none focus:outline-none focus:ring-2 focus:ring-green-600"
                onclick="askSampleQuestion('What do my lab results mean overall?')"
                onkeypress="if(event.key==='Enter' || event.key===' ') askSampleQuestion('What do my lab results mean overall?')"
              >
                What do my results mean?
              </div>
              <div
                tabindex="0"
                role="button"
                class="sample-question cursor-pointer bg-gray-200 hover:bg-gray-300 rounded-full px-4 py-2 text-sm select-none focus:outline-none focus:ring-2 focus:ring-green-600"
                onclick="askSampleQuestion('Are any of my values outside normal range?')"
                onkeypress="if(event.key==='Enter' || event.key===' ') askSampleQuestion('Are any of my values outside normal range?')"
              >
                Any abnormal values?
              </div>
              <div
                tabindex="0"
                role="button"
                class="sample-question cursor-pointer bg-gray-200 hover:bg-gray-300 rounded-full px-4 py-2 text-sm select-none focus:outline-none focus:ring-2 focus:ring-green-600"
                onclick="askSampleQuestion('What should I be concerned about?')"
                onkeypress="if(event.key==='Enter' || event.key===' ') askSampleQuestion('What should I be concerned about?')"
              >
                What should I watch?
              </div>
              <div
                tabindex="0"
                role="button"
                class="sample-question cursor-pointer bg-gray-200 hover:bg-gray-300 rounded-full px-4 py-2 text-sm select-none focus:outline-none focus:ring-2 focus:ring-green-600"
                onclick="askSampleQuestion('Explain the medical terms in my report')"
                onkeypress="if(event.key==='Enter' || event.key===' ') askSampleQuestion('Explain the medical terms in my report')"
              >
                Explain medical terms
              </div>
            </div>
          </div>

          <div
            id="questionLoading"
            class="text-gray-600 italic hidden select-none text-center"
            aria-live="polite"
          >
            Analyzing your question
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    let currentSessionId = null;

    const popupOverlay = document.getElementById("popup-overlay");

    // Elements inside popup
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("pdfFile");
    const uploadLoading = document.getElementById("uploadLoading");
    const chatSection = document.getElementById("chatSection");
    const questionInput = document.getElementById("questionInput");
    const askBtn = document.getElementById("askBtn");
    const questionLoading = document.getElementById("questionLoading");
    const chatContainer = document.getElementById("chatContainer");
    const fileInfo = document.getElementById("fileInfo");

    // Initialize popup visible on page load
    window.addEventListener("load", () => {
      resetPopup();
      questionInput.focus();
      document.body.style.overflow = "hidden";
    });

    function closePopup() {
      popupOverlay.style.display = "none";
      popupOverlay.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    function resetPopup() {
      currentSessionId = null;
      uploadLoading.classList.add("hidden");
      uploadArea.classList.remove("hidden");
      chatSection.classList.add("hidden");
      fileInfo.innerHTML = "";
      chatContainer.innerHTML = `<div class="message bot-message bg-white border border-gray-300 text-gray-800 rounded-xl p-4 max-w-[80%] break-words">
                <strong>ü§ñ Medical Assistant:</strong><br>
                Hello! I've successfully processed your lab report. I can help explain:
                <ul class="list-disc list-inside mt-2 space-y-1">
                    <li>What each test measures</li>
                    <li>Normal ranges for lab values</li>
                    <li>What high or low results might indicate</li>
                    <li>Medical terms in simple language</li>
                </ul>
                <em class="block mt-3 text-sm text-gray-600">Please remember: I provide educational information only. Always consult your healthcare provider for medical advice.</em>
            </div>`;
      questionInput.value = "";
      askBtn.disabled = false;
      questionLoading.classList.add("hidden");
    }

    uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadArea.classList.add("scale-105", "border-green-600", "bg-green-50");
    });

    uploadArea.addEventListener("dragleave", () => {
      uploadArea.classList.remove("scale-105", "border-green-600", "bg-green-50");
    });

    uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.classList.remove("scale-105", "border-green-600", "bg-green-50");
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileUpload(files[0]);
      }
    });

    fileInput.addEventListener("change", (e) => {
      if (e.target.files.length > 0) {
        handleFileUpload(e.target.files[0]);
      }
    });

    function handleFileUpload(file) {
      if (file.type !== "application/pdf") {
        showError("Please select a PDF file.");
        return;
      }

      if (file.size > 16 * 1024 * 1024) {
        showError("File size must be less than 16MB.");
        return;
      }

      uploadLoading.classList.remove("hidden");
      uploadArea.classList.add("hidden");

      const formData = new FormData();
      formData.append("pdf", file);

      fetch("/upload", {
        method: "POST",
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          uploadLoading.classList.add("hidden");

          if (data.error) {
            showError(data.error);
            uploadArea.classList.remove("hidden");
          } else {
            currentSessionId = data.session_id;
            showSuccess("PDF uploaded successfully!");
            showChat(data);
          }
        })
        .catch((error) => {
          uploadLoading.classList.add("hidden");
          uploadArea.classList.remove("hidden");
          showError("Upload failed: " + error.message);
        });
    }

    function showChat(data) {
      fileInfo.innerHTML = `
                <strong>üìã File:</strong> ${data.filename}<br>
                <strong>üìä Content:</strong> ${data.text_length} characters extracted<br>
                <strong>‚úÖ Status:</strong> Ready for questions
            `;
      chatSection.classList.remove("hidden");
      questionInput.focus();
    }

    function askQuestion() {
      const question = questionInput.value.trim();
      if (!question) return;

      if (!currentSessionId) {
        showError("Please upload a PDF first.");
        return;
      }

      addMessage(question, "user");
      questionInput.value = "";

      questionLoading.classList.remove("hidden");
      askBtn.disabled = true;

      fetch("/ask", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          query: question,
          session_id: currentSessionId,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          questionLoading.classList.add("hidden");
          askBtn.disabled = false;

          if (data.error) {
            addMessage("‚ùå " + data.error, "bot");
          } else {
            addMessage(data.response, "bot");
          }
        })
        .catch((error) => {
          questionLoading.classList.add("hidden");
          askBtn.disabled = false;
          addMessage("‚ùå Error: " + error.message, "bot");
        });
    }

    function addMessage(text, sender) {
      const messageDiv = document.createElement("div");
      messageDiv.className =
        "message rounded-xl p-4 max-w-[80%] break-words " +
        (sender === "user"
          ? "bg-green-600 text-white ml-auto text-right"
          : "bg-white border border-gray-300 text-gray-800");

      if (sender === "user") {
        messageDiv.innerHTML = `<strong>You:</strong><br>${text}`;
      } else {
        const formattedText = text
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>")
          .replace(/\n\n/g, "<br><br>")
          .replace(/\n/g, "<br>");
        messageDiv.innerHTML = `<strong>ü§ñ Medical Assistant:</strong><br>${formattedText}`;
      }

      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function askSampleQuestion(question) {
      questionInput.value = question;
      askQuestion();
    }

    function handleKeyPress(event) {
      if (event.key === "Enter") {
        askQuestion();
      }
    }

    function showError(message) {
      const errorDiv = document.createElement("div");
      errorDiv.className =
        "bg-red-100 border-l-4 border-red-600 text-red-700 p-4 rounded-md mb-4";
      errorDiv.textContent = message;
      const mainContent = document.getElementById("popup-main-content");
      const uploadSection = mainContent.querySelector(".upload-section");
      mainContent.insertBefore(errorDiv, uploadSection);

      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    function showSuccess(message) {
      const successDiv = document.createElement("div");
      successDiv.className =
        "bg-green-100 border-l-4 border-green-600 text-green-700 p-4 rounded-md mb-4";
      successDiv.textContent = message;
      const mainContent = document.getElementById("popup-main-content");
      const uploadSection = mainContent.querySelector(".upload-section");
      mainContent.insertBefore(successDiv, uploadSection);

      setTimeout(() => {
        successDiv.remove();
      }, 3000);
    }
  </script>
</body>
</html>