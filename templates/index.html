<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medical Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
  />
  <style>
    #chatContainer::-webkit-scrollbar {
      width: 8px;
    }
    #chatContainer::-webkit-scrollbar-thumb {
      background-color: #4caf50;
      border-radius: 4px;
    }
    #chatContainer::-webkit-scrollbar-track {
      background: #f0f0f0;
    }
    .drop-zone-active {
      border-color: #16a34a !important;
      background-color: #dcfce7 !important;
      transform: scale(1.02);
    }
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #6b7280;
      animation: typing 1.4s infinite ease-in-out;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
    .doctor-card {
      transition: all 0.3s ease;
    }
    .doctor-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .message-content {
      line-height: 1.6;
    }
    .message-content ul {
      margin: 0.5rem 0;
    }
    .message-content li {
      margin: 0.25rem 0;
    }
    .message-content strong {
      font-weight: 600;
    }
    .message-content p {
      margin: 0.5rem 0;
    }
    .message-type-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
    }
    .type-symptoms {
      background-color: #fef3c7;
      color: #d97706;
    }
    .type-report {
      background-color: #dbeafe;
      color: #2563eb;
    }
    .type-general {
      background-color: #f3e8ff;
      color: #7c3aed;
    }
    .quick-upload {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }
    .quick-upload input[type=file] {
      position: absolute;
      left: -9999px;
    }
    .pulse-dot {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-500 via-purple-600 to-indigo-800 min-h-screen">
  <!-- Header -->
  <header class="bg-white/10 backdrop-blur-md border-b border-white/20 p-4">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-3xl">üè•</div>
        <div>
          <h1 class="text-2xl font-bold text-white">Smart Medical Assistant</h1>
          <p class="text-white/80 text-sm">
            <span class="pulse-dot">‚óè</span> 
            Auto-detects symptoms, reports, and general questions
          </p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="quick-upload">
          <input type="file" id="quickPdfFile" accept=".pdf" />
          <label for="quickPdfFile" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2 cursor-pointer">
            <i class="fas fa-upload"></i>
            Quick Upload
          </label>
        </div>
        <button 
          id="clearBtn" 
          class="bg-red-500/20 hover:bg-red-500/30 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2"
          onclick="clearChat()"
        >
          <i class="fas fa-trash"></i>
          Clear
        </button>
      </div>
    </div>
  </header>

  <div class="max-w-6xl mx-auto p-4 h-[calc(100vh-120px)] flex flex-col">
    <!-- File Info (Hidden by default) -->
    <div id="fileInfo" class="hidden bg-green-500/20 border border-green-500/30 rounded-lg p-4 mb-4 text-white">
    </div>

    <!-- Chat Container -->
    <div class="flex-1 bg-white/10 backdrop-blur-md rounded-xl border border-white/20 flex flex-col overflow-hidden">
      <!-- Chat Messages -->
      <div 
        id="chatContainer" 
        class="flex-1 p-6 overflow-y-auto space-y-4"
      >
        <!-- Welcome Message -->
        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white text-sm">
            ü§ñ
          </div>
          <div class="bg-white rounded-lg p-4 max-w-[80%] shadow-sm">
            <div class="font-semibold text-gray-800 mb-2">Smart Medical Assistant</div>
            <div class="text-gray-700">
              Hello! I'm your intelligent medical assistant. I can automatically detect and help with:
              <ul class="list-disc list-inside mt-2 space-y-1">
                <li><span class="font-semibold text-orange-600">Symptoms</span> - Describe how you feel and get doctor recommendations</li>
                <li><span class="font-semibold text-blue-600">Lab Reports</span> - Upload PDFs for instant analysis</li>
                <li><span class="font-semibold text-purple-600">General Questions</span> - Ask about health conditions, medications, etc.</li>
              </ul>
              <div class="mt-3 p-3 bg-blue-50 border-l-4 border-blue-400 text-sm text-blue-800">
                <strong>Smart Detection:</strong> Just type your message naturally - I'll automatically understand what type of help you need!
              </div>
              <div class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-sm text-yellow-800">
                <strong>Important:</strong> I provide educational information only. Always consult your healthcare provider for medical advice.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="p-4 border-t border-white/20">
        <div class="flex gap-3">
          <input
            type="text"
            id="questionInput"
            class="flex-1 bg-white/90 border border-gray-300 rounded-lg px-4 py-3 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
            placeholder="Type anything: symptoms, questions, or drag & drop a PDF report..."
            onkeypress="handleKeyPress(event)"
          />
          <button
            id="sendBtn"
            onclick="sendMessage()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed"
          >
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>

        <!-- Sample Questions -->
        <div class="mt-4">
          <div class="text-white/80 text-sm mb-2">Try these examples:</div>
          <div class="flex flex-wrap gap-2">
            <button 
              class="bg-orange-500/20 hover:bg-orange-500/30 text-white text-xs px-3 py-1 rounded-full transition-all duration-200 border border-orange-500/30"
              onclick="askSampleQuestion('I have severe headache and nausea for 2 days')"
            >
              ü©∫ Symptom example
            </button>
            <button 
              class="bg-purple-500/20 hover:bg-purple-500/30 text-white text-xs px-3 py-1 rounded-full transition-all duration-200 border border-purple-500/30"
              onclick="askSampleQuestion('What causes high blood pressure?')"
            >
              ‚ùì General question
            </button>
            <button 
              class="bg-blue-500/20 hover:bg-blue-500/30 text-white text-xs px-3 py-1 rounded-full transition-all duration-200 border border-blue-500/30"
              onclick="askSampleQuestion('Explain my cholesterol levels')"
            >
              üìä Report question
            </button>
            <button 
              class="bg-green-500/20 hover:bg-green-500/30 text-white text-xs px-3 py-1 rounded-full transition-all duration-200 border border-green-500/30"
              onclick="askSampleQuestion('feeling dizzy and tired, what specialist should I see?')"
            >
              üë®‚Äç‚öïÔ∏è Doctor recommendation
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Drag & Drop Overlay -->
  <div id="dragOverlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-8 text-center max-w-md mx-4">
      <div class="text-6xl mb-4">üìÑ</div>
      <h3 class="text-xl font-bold text-gray-800 mb-2">Drop PDF Report Here</h3>
      <p class="text-gray-600">Release to upload your lab report for analysis</p>
    </div>
  </div>

  <script>
    let currentSessionId = null;
    let isProcessing = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      document.getElementById('questionInput').focus();
    });

    function setupEventListeners() {
      const quickFileInput = document.getElementById('quickPdfFile');
      
      // Quick file upload
      quickFileInput.addEventListener('change', handleQuickFileSelect);

      // Global drag and drop
      document.addEventListener('dragover', handleGlobalDragOver);
      document.addEventListener('dragleave', handleGlobalDragLeave);
      document.addEventListener('drop', handleGlobalDrop);
    }

    function handleQuickFileSelect(e) {
      const file = e.target.files[0];
      if (file) {
        handleFileUpload(file);
      }
    }

    function handleGlobalDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // Check if dragged item contains files
      if (e.dataTransfer.types.includes('Files')) {
        document.getElementById('dragOverlay').classList.remove('hidden');
      }
    }

    function handleGlobalDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // Only hide if leaving the window
      if (e.clientX === 0 || e.clientY === 0) {
        document.getElementById('dragOverlay').classList.add('hidden');
      }
    }

    function handleGlobalDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('dragOverlay').classList.add('hidden');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.type === 'application/pdf') {
          handleFileUpload(file);
        } else {
          showError('Please upload a PDF file only.');
        }
      }
    }

    async function handleFileUpload(file) {
      if (file.size > 16 * 1024 * 1024) {
        showError('File size must be less than 16MB.');
        return;
      }

      const formData = new FormData();
      formData.append('pdf', file);

      try {
        setLoading(true);
        addMessage('system', `üì§ Uploading "${file.name}"...`);
        
        const response = await fetch('/upload', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (response.ok) {
          currentSessionId = result.session_id;
          showFileInfo(result.filename, result.text_length);
          addMessage('system', `‚úÖ PDF "${result.filename}" uploaded successfully! You can now ask questions about your lab report.`);
        } else {
          showError(result.error || 'Upload failed');
        }
      } catch (error) {
        showError('Upload failed: ' + error.message);
      } finally {
        setLoading(false);
      }
    }

    function showFileInfo(filename, textLength) {
      const fileInfo = document.getElementById('fileInfo');
      fileInfo.innerHTML = `
        <div class="flex items-center gap-3">
          <i class="fas fa-file-pdf text-green-400"></i>
          <div>
            <div class="font-semibold">${filename}</div>
            <div class="text-sm text-white/80">${textLength} characters extracted</div>
          </div>
          <button onclick="clearFile()" class="ml-auto text-white/60 hover:text-white">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      fileInfo.classList.remove('hidden');
    }

    function clearFile() {
      currentSessionId = null;
      document.getElementById('fileInfo').classList.add('hidden');
      document.getElementById('quickPdfFile').value = '';
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // Smart detection of message type
    function detectMessageType(query) {
      const lowerQuery = query.toLowerCase();
      
      // Symptom keywords
      const symptomKeywords = [
        'pain', 'ache', 'hurt', 'sore', 'burning', 'itching', 'swelling',
        'fever', 'headache', 'nausea', 'vomiting', 'diarrhea', 'constipation',
        'dizzy', 'tired', 'fatigue', 'weakness', 'shortness of breath',
        'cough', 'sneeze', 'runny nose', 'congestion', 'rash', 'bleeding',
        'cramps', 'spasms', 'stiffness', 'numbness', 'tingling',
        'feel', 'feeling', 'experiencing', 'having', 'suffering',
        'days', 'weeks', 'hours', 'since', 'ago', 'started',
        'doctor', 'specialist', 'recommend', 'see', 'visit'
      ];

      // Report keywords
      const reportKeywords = [
        'report', 'results', 'test', 'lab', 'blood', 'urine', 'levels',
        'cholesterol', 'glucose', 'hemoglobin', 'creatinine', 'bilirubin',
        'analysis', 'interpret', 'explain', 'mean', 'normal', 'abnormal',
        'high', 'low', 'elevated', 'decreased', 'values'
      ];

      const symptomCount = symptomKeywords.filter(keyword => lowerQuery.includes(keyword)).length;
      const reportCount = reportKeywords.filter(keyword => lowerQuery.includes(keyword)).length;

      // If uploaded file exists and query seems report-related
      if (currentSessionId && reportCount > 0) {
        return 'report';
      }
      
      // If multiple symptom keywords or typical symptom patterns
      if (symptomCount >= 2 || 
          /feel(ing)?\s+(sick|unwell|bad|terrible|awful)/i.test(query) ||
          /have\s+(been|a|an)\s+\w+ing/i.test(query) ||
          /\d+\s+(day|week|hour|month)s?\s+(ago|of|with)/i.test(query)) {
        return 'symptoms';
      }

      return 'general';
    }

    async function sendMessage() {
      const input = document.getElementById('questionInput');
      const query = input.value.trim();
      
      if (!query || isProcessing) return;

      // Detect message type
      const messageType = detectMessageType(query);
      
      addMessage('user', query, messageType);
      input.value = '';
      
      try {
        setLoading(true);
        
        let response;
        
        if (messageType === 'symptoms') {
          // Handle as symptoms
          response = await fetch('/symptoms', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              symptoms: query
            })
          });
        } else if (messageType === 'report' && currentSessionId) {
          // Handle as report question
          response = await fetch('/ask', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              query: query,
              session_id: currentSessionId
            })
          });
        } else {
          // Handle as general medical question
          response = await fetch('/ask_general', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              query: query
            })
          });
        }

        const result = await response.json();

        if (response.ok) {
          addMessage('assistant', result.response, messageType);
          
          // Handle doctor recommendations for symptoms
          if (messageType === 'symptoms' && result.recommended_doctors && result.recommended_doctors.length > 0) {
            addDoctorRecommendations(result.recommended_doctors, result.specialization);
          }
        } else {
          showError(result.error || 'Failed to get response');
        }
      } catch (error) {
        showError('Failed to send message: ' + error.message);
      } finally {
        setLoading(false);
      }
    }

    function addDoctorRecommendations(doctors, specialization) {
      const doctorsHtml = doctors.map(doctor => `
        <div class="doctor-card bg-white/90 rounded-lg p-4 mb-3 border border-gray-200">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-semibold text-gray-800">${doctor.name}</div>
              <div class="text-sm text-gray-600">${doctor.specialization}</div>
              <div class="text-sm text-gray-500">${doctor.location}</div>
            </div>
            <div class="text-right">
              <div class="text-yellow-500 text-sm">
                ${'‚òÖ'.repeat(Math.floor(doctor.rating))} ${doctor.rating}
              </div>
            </div>
          </div>
        </div>
      `).join('');

      const recommendationMessage = `
        <div class="mb-4">
          <h4 class="font-semibold text-gray-800 mb-3">
            <i class="fas fa-user-md text-blue-600 mr-2"></i>
            Recommended Doctors (${specialization.charAt(0).toUpperCase() + specialization.slice(1)}):
          </h4>
          ${doctorsHtml}
        </div>
      `;

      addMessage('system', recommendationMessage);
    }

    function addMessage(sender, content, messageType = null) {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex items-start gap-3';

      let avatar, bgColor, textColor;
      
      if (sender === 'user') {
        avatar = 'üë§';
        bgColor = 'bg-blue-500';
        textColor = 'text-white';
        messageDiv.className += ' flex-row-reverse';
      } else if (sender === 'system') {
        avatar = 'üí°';
        bgColor = 'bg-green-500';
        textColor = 'text-white';
      } else {
        avatar = 'ü§ñ';
        bgColor = 'bg-white';
        textColor = 'text-gray-700';
      }

      // Add message type indicator for user messages
      let typeIndicator = '';
      if (sender === 'user' && messageType) {
        const typeConfig = {
          'symptoms': { icon: 'ü©∫', label: 'Symptoms Analysis', class: 'type-symptoms' },
          'report': { icon: 'üìä', label: 'Report Question', class: 'type-report' },
          'general': { icon: '‚ùì', label: 'General Question', class: 'type-general' }
        };
        
        const config = typeConfig[messageType];
        if (config) {
          typeIndicator = `
            <div class="message-type-indicator ${config.class}">
              ${config.icon} ${config.label}
            </div>
          `;
        }
      }

      messageDiv.innerHTML = `
        <div class="w-8 h-8 ${sender === 'user' ? 'bg-blue-600' : 'bg-green-600'} rounded-full flex items-center justify-center text-white text-sm">
          ${avatar}
        </div>
        <div class="${bgColor} rounded-lg p-4 max-w-[80%] shadow-sm">
          <div class="font-semibold ${textColor} mb-2">
            ${sender === 'user' ? 'You' : sender === 'system' ? 'System' : 'Medical Assistant'}
          </div>
          ${typeIndicator}
          <div class="message-content ${textColor}">
            ${parseMarkdown(content)}
          </div>
        </div>
      `;

      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function parseMarkdown(text) {
      // Simple markdown parsing
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/^(.*)$/gm, '<p>$1</p>')
        .replace(/‚Ä¢ /g, '<li>')
        .replace(/<p><li>/g, '<ul><li>')
        .replace(/<\/li><\/p>/g, '</li></ul>');
    }

    function askSampleQuestion(question) {
      document.getElementById('questionInput').value = question;
      sendMessage();
    }

    function showError(message) {
      addMessage('system', `‚ùå Error: ${message}`);
    }

    function setLoading(loading) {
      isProcessing = loading;
      const sendBtn = document.getElementById('sendBtn');
      
      if (loading) {
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // Add typing indicator
        addTypingIndicator();
      } else {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        
        // Remove typing indicator
        removeTypingIndicator();
      }
    }

    function addTypingIndicator() {
      const chatContainer = document.getElementById('chatContainer');
      const typingDiv = document.createElement('div');
      typingDiv.id = 'typingIndicator';
      typingDiv.className = 'flex items-start gap-3';
      typingDiv.innerHTML = `
        <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white text-sm">
          ü§ñ
        </div>
        <div class="bg-white rounded-lg p-4 shadow-sm">
          <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      `;
      chatContainer.appendChild(typingDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function removeTypingIndicator() {
      const typingIndicator = document.getElementById('typingIndicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    function clearChat() {
      const chatContainer = document.getElementById('chatContainer');
      chatContainer.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white text-sm">
            ü§ñ
          </div>
          <div class="bg-white rounded-lg p-4 max-w-[80%] shadow-sm">
            <div class="font-semibold text-gray-800 mb-2">Smart Medical Assistant</div>
            <div class="text-gray-700">
              Hello! I'm your intelligent medical assistant. I can automatically detect and help with:
              <ul class="list-disc list-inside mt-2 space-y-1">
                <li><span class="font-semibold text-orange-600">Symptoms</span> - Describe how you feel and get doctor recommendations</li>
                <li><span class="font-semibold text-blue-600">Lab Reports</span> - Upload PDFs for instant analysis</li>
                <li><span class="font-semibold text-purple-600">General Questions</span> - Ask about health conditions, medications, etc.</li>
              </ul>
              <div class="mt-3 p-3 bg-blue-50 border-l-4 border-blue-400 text-sm text-blue-800">
                <strong>Smart Detection:</strong> Just type your message naturally - I'll automatically understand what type of help you need!
              </div>
              <div class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-sm text-yellow-800">
                <strong>Important:</strong> I provide educational information only. Always consult your healthcare provider for medical advice.
              </div>
            </div>
          </div>
        </div>
      `;
      clearFile();
    }
  </script>
</body>
</html>